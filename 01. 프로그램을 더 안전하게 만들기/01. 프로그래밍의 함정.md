# 프로그래밍의 함정
프로그램이 일련의 처리를 수행하는 거좡을 묘사하는 기법이라고 생각하는 경우가 많다.  
이런 묘사에는 문제를 해결하기 위해 프로그램이 사용하는 모델(model)에서 변경하는 동작과 모델의 상태 변이 결과에 대한 의사 결정이 포함된다.  
상태 변이와 의사 결정은 프로그래머가 아닌 일반인들도 이해하고 수행할 수 있는 방식이다.  

더 복잡한 과업을 완수해야 한다면 그 과업을 여러 단계로 나눈다.  
그 후, 첫 단계를 실행하고 결과를 검사한다.  
결과 검사에 따라 다음에 수행할 단계를 정할 수 있다.  
예를 들어 두 양수 a와 b를 추가하는 프로그램을 다음과 같은 의사코드(pseudocode)로 표현할 수 있다.
- 만약 b = 0이면, a를 반환하라
- 그렇지 않으면 a를 1만큼 증가시키로 b를 1만큼 감소해라
- 이렇게 변경한 a와 b를 가지고 전체 과정을 다시 수행해라

이를 흐름도(전개도)로 표현하면 더 명확하게 코드가 어떻게 돌아가는지를 확인할 수 있다.  

하지만 이러한 코드를 작성하면서 하나의 수식을 잘못한다던지, 조건을 잘못 적게된다면 코드가 완전히 끝나지 않거나 실행이 안되게 될 것이다.  
이를 해결하기 위해 조금씩 프로그래밍을 해보면서 방식을 조금씩 훈련하는 것이다.  

상태 변이나 루프 같은 위험한 기능은 사용하지 말고, 가변 참조나 루프가 필요한 경우 그들을 추상화하면 된다.  
상태 변이를 추상화하는 컴포넌트를 단 한번만 작성하면 그 후에는 같은 문제를 다시 처리할 필요가 없다.  

버그를 자주 일으키는 다른 근원에는 널 참조가 있다.  
코틀린을 사용하면 널 참조를 허용하는 코드와 널 참조를 금지하는 코드를 분리할 수 있다.  
하지만 궁극적으로 프로그램에서 널 참조를 아예 사용하지 못하게 막는 일은 개개인의 책임이다.  

외부에 의존하는 프로그램을 제대로 실행하려고 노력하는 과정에서 많은 버그가 발생한다.  
하지만 어떤 프로그램이든 어느 정도 외부에 의존하기 마련이다.  
이런 의존 관계를 프로그램의 일부분으로 제한하면, 외부에 대한 의존으로 인해 생길 수 있는 버그를 완전히 제거하지는 못하더라도 문제를 더 쉽게 찾아내로 다룰 수 있다.  
이 책에서 프로그램을 더 안전하게 만들기 위한 다음 몇 가지 방법을 볼 수 있다.
- 가변 참조(변수) 사용을 피하고, 상태 변이를 피할 수 없는 경우에는 그 부분을 추상화 한다.
- 제어 구조를 피하라
- 효과를 개인이 작성하는 프로그램의 일부 영역 안에서만 일어나도록 제한하라. 이는 프로그램을 작성할 때 일부 한정된 영역을 제외한 나머지 부분에서 콘솔 등의 장치에 출력하거나 파일, DB, 네트워크 등의 장치에 데이터를 쓰는 등의 행위를 하지 말아야 한다는 뜻이다.
- 예외를 던지지 말라. 예외를 던지는 것은 무조것 분기(GOTO)의 현대적인 변형이라 할 수 있다. 이로 인해 프로그램이 **스파게티 코드**(spaghetti code)가 될 수 있다.  
스파게티 코드라는 말은 프로그램의 흐름이 어디서 시작하는지 알 수 있지만, 어디로 흘러가는지 제대로 따라갈 수 없다는 뜻이다.

## 1.1.1 안전하게 부수효과 처리하기
프로그램은 일반적으로 자신만의 영역이 있는 작은 블록으로 이루어진다.  
어떤 언어는 이런 블록을 **프러시저**(procedure)라고 부르고, 다른 언어(자바 등)는 **메서드**(method)라고 부른다.  
코틀린에서는 이런 블록을 **함수**(function)라고 한다.

코틀린 함수는 기본적으로 메서드다.  
메서드라는 코드 블록에는 **영역**(scope)이 있다.  
영역이란 말은 코드 블록 안에서 볼 수 있는 정의나 선언이 프로그램의 어떤 범위에 속하는 지를 뜻한다.  
블록은 그 자신이 둘러싸고 있는 영역을 볼 수 있을 뿐만 아니라 자신의 바깥쪽 영역을 볼 수 있고, 추이적(transative)으로 자신을 둘러싼 영역을 감싸는 더 바깥쪽 영역을 볼 수 있어서 최종적으로는 가장 바깥 영역에 이른느 모든 영역을 볼 수 있다.  
함수나 메서드가 외부 영역의 상태를 바꾸는 것이 바로 효과이다.  

일부 메서드는 값을 반환하고, 일부 메서드는 세계의 상태를 변경하며, 일부 메서드는 값을 반환하는 동시에 상태를 변경한다.  
값을 반환하는 메서드나 함수가 외부 상태를 변경하는 경우, 이를 **부수 효과**(side effect)라고 한다.  
부수 효과를 사용하는 프로그램은 잘못된 것이다.  
의약품과 관련해 '부작용'이라는 말은 주된 약효 이외 나타나는 부수적인 효과를 뜻하기보다는 부정적인 효과를 뜻하는 경우가 많다.  
프로그래밍에서 부수 효과는 프로그램이 반환하는 결과값에 덧붙여 프로그램 밖에서 관찰할 수 있든 어떤 변화를 뜻한다.  

프로그램이 결과를 반환하지 않는다면 관찰 가능한 효과를 부수 효과라고 부를 수 없다.  
결과를 반환하지 않는 프로그램에서는 상태 변화가 주된 효과이기 때문이다.  
하지만 그런 경우에도 여전히 (이차적인)부수효과가 있을 수 있다.  
물론 이런 부수 효과는 '단일 책임(single responsibility)' 원칙이라는 실무 지침을 위배하는 좋지 못한 방법이다.  
안전한 프로그램은 인자를 받아서 값을 반환하는 여러 함수를 합성해 만들어진다.  
그리고 그런 함수 합성이 프로그램을 이루는 전부다.  
우리는 함수 안에서 어떤 일이 벌어지는지 신경 쓰지 않는다.  
이론적으로 함수 안에서는 아무런 일도 벌어지지 않기 때문이다.  
일부 언어는 부수효과거 없는 함수를 제공한다.  
그런 언어로 작성된 프로그램은 반환 값 외에는 아무런 효과도 관찰할 수 없다.  
하지만 실제로 반환하는 값이 상태 변이를 통해 발생하는 효과를 계산하고자 실행하는 새로운 프로그램일 수도 있다.  
이런식으로 효과를 만들어내는 프로그램을 반환하는 기법은 언어와 무관하게 사용할 수는 있지만, 종종 비효율적인 기법이라고 여려진다.  
그보다 더 안전한 대안은 효과 계산 때문에 일어나는 상태 변이와 ㅍ로그램의 나머지 부분을 분리하거나 심지어는 효과를 계산하는 부분을 최대한 추상화하는 것이다. 

## 1.1.2 참조 투명셩으로 프로그램을 더 안전하게 만들기
부수 효과를 없애는 것만으로는 프로그램을 충분히 안전하고 결정적으로 만들 수 없다.  
프로그램을 충분히 안전하고 결정적으로 만들려면 외부 세계로부터 영향을 받아서도 안된다.  
즉, 프로그램의 출력은 오직 그 인자에 의해서만 영향을 받아야 한다.  
이는 프로그램이 데이터를 콘솔, 파일, 원격 URL, 데이터베이스에서 읽을 수 없음은 물론이고, 심지어 시스템의 데이터를 받을 수도 없다는 뜻이다.  

외부 세계의 상태를 변경하지도 않고 외부 상태에 의존하지도 않는 코드를 일컫어 **참조 투명**(referentially transparent)하다고 한다.  
참조 투명한 코드에는 몇 가지 흥미로운 특성이 있다.
- 참조 투명한 코드는 **자기 완결적이다.** 어떤 문맥에서나 그 코드를 사용할 수 있다. 단지 올바른 인자를 그 코드에 제공하기만 하면 된다.
- 참조 투명한 코드는 **결정적이다.** 인자가 같으면 항상 결과도 같기 때문에 개발자를 놀라게 하는 일은 없다. 하지만 잘못된 참조 투명한 코드도 잘못된 결과값을 돌려줄 수는 있다. 그렇지만 적어도 같은 인자에 대해 항상 같은 결과를 보장한다.
- 참조 투명한 코드는 **절대 예외를 던지지 않는다.** 다만 참조 투명한 코드도 메모리 부족 오류(OOME, Out Of Memory Error)나 스택 오버플로우 오류(SOE, Stack Overflow Error)를 발생시킬수는 있다. 하지만 이런 오류는 프로그램에 버그가 있음을 뜻한다. 메모리 부족이나 스택 오버플로우 등은 프로그래머나 개발자가 제공하는 API를 사용하는 쪽에서 처리를 할 수 있는 오류 상황이 아니다. 이런 오류가 발생할 때 취할 수 있는 방법은 어플리케이션을 중단하고 버그를 수정해야 한다.
- 참조 투명한 코드는 **예기치 않게 다른 코드가 실패하는 상황을 만들지 않는다.** 인자를 변경하거나 다른 외부 데이터를 변경하지 않으며, 그에 따라 코드를 호출하는 쪽의 데이터가 오염되거나 동시 접근으로 인해 오류가 발생하는 경우가 없다.
- 참조 투명한 코드는 **자신이 제대로 작동하기 위해 외부 장치에 의존하지 않는다.** 외부 장치를 사용할 수 없거나, 외부 장치가 너무 느리거나 고장 나서 코드가 계속 대기 상태에 머무는 경우가 없다.

참조 투명한 프로그램은 인자로 값을 받아서 결과값을 내놓는 행위를 제외하고는 외부 세계외 상호작용하지 않는다.  
이는 프로그램의 결과값은 인자 값에만 의존한다.
  
하지만 참조 투명하지 않은 프로그램은 외부 세계의 요소로부터 데이터를 읽고 쓰거나 파일에 로그를 남기거나 외부 객체의 상태를 바꾸거나 키보드 입력을 받거나 화면에 출력하는 등의 작용을 한다.  
이의 결과는 예측 불가능하다.